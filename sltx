#!/usr/bin/env python3

# Simple LaTeX INSTaller
# sltxinst

# TODO: check versioning
# TODO: do not install if already done
# TODO: symlink options?
# TODO: maybe add version to output?

import argparse
import os  # list directory
import sys  # cmd line args

from sltxpkg import globals as sg

from sltxpkg.commands import cmd_compile, cmd_dependency, cmd_gen_gha, cmd_docker, cmd_version

def valid_file(arg: str):
    if arg is None or arg.strip() == "":
        raise ValueError("arg vas none or empty")
    if not os.path.isfile(arg):
        raise FileNotFoundError("\"" + arg + "\" must be an existing file")
    return arg

# TODO: cleanup arguments

commands = {
    'dependency': cmd_dependency, 'docker': cmd_docker, 'compile': cmd_compile, 'gen-gha': cmd_gen_gha, 'version': cmd_version}

parser = argparse.ArgumentParser(
    description="sltx, a Simple LaTeX-INSTaller utility")

# commands, parser.add_mutually_exclusive_group()
parser.add_argument('command', nargs='?',
                    help="Command to be used. Defaults to 'dependency'. Possible values are " + str(list(commands.keys())),
                    default='dependency')
parser.add_argument('-c', '--config', dest='config', metavar='config.yml',
                    required=False, type=valid_file,
                    help="the file to load the configuration from. Only valid with 'dependency'.")
parser.add_argument('-d', '--dependencies', dest='dep', metavar='dep.yml',
                    required=False, type=valid_file,
                    help="the file to load the dependencies from. Only valid with 'dependency'.")
parser.add_argument('-t', '--threads', metavar='N', dest='threads', type=int,
                    help="number of threads to run the installation. Default is 1. This number will only affect some routines.",
                    default=1)

if(len(sys.argv) <= 1):
    parser.parse_args(['-h'])

sg.args = parser.parse_args()

try:
    cmd = commands[sg.args.command]
except KeyError:
    print("The supplied command:",sg.args.command,"is unknown. Choose one of:",list(commands.keys()))

cmd()

# TODO: if no deps or no generate call
