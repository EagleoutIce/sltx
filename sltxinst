#!/usr/bin/env python3

# Simple LaTeX INSTaller
# sltxinst

# TODO: setup other projects with this
# TODO: check versioning
# TODO: do not install if already done
# TODO: symlink options?

import glob  # glob :P
import os  # list directory
import re  # matching files
import shutil  # clean working dir
from subprocess import Popen, PIPE  # execution
import sys  # cmd line args
import zipfile  # extracting zips

import yaml  # Parse config file

DEFAULT_CONFIG = "./sltx-config.yml"
C_DRIVER_LOG = "driver_log"
C_TEX_HOME = "tex_home"
C_WORKING_DIR = "working_dir"
C_CREATE_DIRS = "create_dirs"
C_CLEANUP = "cleanup"
C_AUTODETECT_DRIVERS = "autodetect_drivers"
C_DRIVERS = "drivers"
C_DRIVER_PATTERNS = "driver_patterns"

configuration = {
    C_TEX_HOME: "~/texmf/tex/latex/sltxinst",
    C_WORKING_DIR: "~/.sltxinst",
    C_DRIVER_LOG: "sltx-drivers.log",
    C_CREATE_DIRS: True,
    C_CLEANUP: True,  # TODO: implement; TODO: only grab interesting files if not already there
    # "recursive": True, TODO: recursive
    C_AUTODETECT_DRIVERS: True,
    # TODO maybe specific install routine instead of plain copy
    C_DRIVERS: {
        "git": {
            "command": "git clone --depth 1 {args} \"{url}\" \"{working_dir}/{dep_name}\"",
            "target-dir": "{working_dir}/{dep_name}",
            "needs-delete": True  # if already exists
            # TODO: maybe update routine?
        }
        # TODO: other
    },
    C_DRIVER_PATTERNS: {
        "git": ["github", "gitlab"]
    }
}

dependencies = {}
loaded = []


def write_to_log(data: str):
    if configuration[C_DRIVER_LOG].strip():
        with open(configuration[C_DRIVER_LOG], 'a') as f:
            f.write(data)


def load_configuration(file: str):
    global configuration
    with open(file, 'r') as yaml_file:
        # FullLoader only available for 5.1 and above:
        if float(yaml.__version__[:yaml.__version__.rfind(".")]) >= 5.1:
            y_conf = yaml.load(yaml_file, Loader=yaml.FullLoader)
        else:
            y_conf = yaml.load(yaml_file)
        configuration = {**configuration, **y_conf}


def load_dependencies_config(file: str):
    global dependencies
    with open(file, 'r') as yaml_file:
        # FullLoader only available for 5.1 and above:
        if float(yaml.__version__[:yaml.__version__.rfind(".")]) >= 5.1:
            y_dep = yaml.load(yaml_file, Loader=yaml.FullLoader)
        else:
            y_dep = yaml.load(yaml_file)
        dependencies = {**dependencies, **y_dep}


def assure_dirs():
    target_path = os.path.expanduser(configuration[C_TEX_HOME])
    create = configuration[C_CREATE_DIRS]
    if not os.path.isdir(target_path):
        if create:
            print("> Tex-Home-Dir", target_path, "not found. Creating...")
            os.makedirs(target_path)
        else:
            print("! Not allowed to create texhome. Exit")
            sys.exit(1)
    configuration[C_TEX_HOME] = target_path  # expansion
    target_path = os.path.expanduser(configuration[C_WORKING_DIR])
    if not os.path.isdir(target_path):
        if create:
            print("> Working-Dir", target_path, "not found. Creating...")
            os.makedirs(target_path)
        else:
            print("! Not allowed to create working-dir. Exit")
            sys.exit(1)
    configuration[C_WORKING_DIR] = target_path  # expansion


def detect_driver(url: str):
    print(" - Autodetecting driver...")
    for key, patterns in configuration[C_DRIVER_PATTERNS].items():
        for pattern in patterns:
            if re.search(pattern, url):
                return key
    print(" ! No driver found...")
    sys.exit(1)


def grab_files_from(path: str, data: dict):
    print(" - Grabby-Grab-Grab files from \"" + path + "\"...")
    if "grab-files" not in data:
        print(" ! Key 'grab-files' not found. Won't grab any files")
        return False

    files = []
    for grab_pattern in data["grab-files"]:
        # maybe forbid level up?
        files.extend(glob.glob(os.path.join(
            path, grab_pattern), recursive=True))
    # extra so i can setup installer afterwards more easily
    print(" > Grabbing the follwing files for installation:", [os.path.relpath(f, path) for f in files])
    for file in files:
        shutil.copy2(file, configuration[C_TEX_HOME])
    return True


def grab_dirs_from(path: str, data: dict):
    print(" - Grabby-Grab-Grab dirs from \"" + path + "\"...")
    if "grab-dirs" not in data:
        print(" ! Key 'grab-dirs' not found. Won't grab any directories")
        return False

    dirs = []
    for grab_pattern in data["grab-dirs"]:
        # maybe forbid level up?
        dirs.extend(glob.glob(os.path.join(
            path, grab_pattern), recursive=True))

    # extra so i can setup installer afterwards more easily
    print(" > Grabbing the follwing dirs for installation:", dirs)
    for dir in dirs:
        # if fails rethrow :D
        shutil.copytree(dir, os.path.join(configuration[C_TEX_HOME], os.path.relpath(dir, path)))

    return True


def write_proc_to_log(stream):
    while True:
        line = stream.readline()
        if not line:
            break
        write_to_log(line.decode('utf-8'))


def use_driver(data: dict, dep_name: str, driver: str, url: str):
    # default no arguments
    if "args" not in data:
        data["args"] = ""
    driver_data = configuration[C_DRIVERS][driver]
    command = driver_data["command"].format(
        **data, **configuration, dep_name=dep_name)
    target_dir = driver_data["target-dir"].format(
        **data, **configuration, dep_name=dep_name)
    if os.path.isdir(target_dir) and driver_data["needs-delete"]:
        print(" - Target folder", target_dir,
              "exists. Will be deleted as the driver needs this")
        shutil.rmtree(target_dir)
    print(" > Executing:", command)
    feedback = Popen(command, stdout=PIPE, stderr=PIPE, shell=True)
    returnCode = feedback.wait()
    write_proc_to_log(feedback.stdout)
    write_proc_to_log(feedback.stderr)

    if returnCode != 0:
        print(" ! Driver failed with code", feedback, "exiting.")
        sys.exit(returnCode)

    got_files = grab_files_from(target_dir, data)
    got_dirs = grab_dirs_from(target_dir, data)
    if not got_files and not got_dirs:
        print(" ! No grabs performed!")
        write_to_log("No grabs performed for: " + dep_name)
    # TODO: grab dirs
    # TODO: error if not files and not dir


def install_dependency(name: str):
    if name in loaded:
        print("Skipping", name, " as it was already loaded by another dep.")
        return
    data = dependencies["dependencies"][name]
    print("Loading \"" + name + "\"")
    if "url" not in data:
        print(" ! The dependency did not have an url-tag attached")
    url = data["url"]
    print(" - Loading from: \"" + url + "\"")
    if "driver" not in data:
        if not configuration[C_AUTODETECT_DRIVERS]:
            print(" ! No driver given and autodetection disabled!")
        else:
            data["driver"] = detect_driver(url)
    driver = data["driver"]
    print(" - Using driver: \"" + driver + "\"")

    if driver not in configuration[C_DRIVERS]:
        print(" ! The selected driver is unknown. Loaded:",
              configuration[C_DRIVERS])
        sys.exit(2)
    use_driver(data, name, driver, url)


if __name__ == "__main__":
    if os.path.isfile(DEFAULT_CONFIG):  # maybe allow 'yaml' too?
        print("Automatically loading '{DEFAULT_CONFIG}'".format(**locals()))
        load_configuration(DEFAULT_CONFIG)

    if len(sys.argv) == 2:  # 1 arg given
        load_dependencies_config(sys.argv[1])
    elif len(sys.argv) == 3:  # 2 arg given
        load_configuration(sys.argv[1])
        load_dependencies_config(sys.argv[2])
    else:
        print("Usage: {prg} [config.yml] dep.yml".format(prg=sys.argv[0]))
        sys.exit(1)

    assure_dirs()

    if "target" not in dependencies or "dependencies" not in dependencies:
        print("The dependency-file must supply a 'target' and an 'dependencies' key!")
        sys.exit(1)

    write_to_log("====Dependencies for:" + dependencies["target"]+"\n")
    print("Dependencies for:", dependencies["target"])
    print("Installing to:", configuration[C_TEX_HOME])
    for dep in dependencies["dependencies"]:
        install_dependency(dep)

    # all installed
    if configuration[C_CLEANUP]:
        print("> Cleaning up the working directory, as set.")
        shutil.rmtree(configuration[C_WORKING_DIR])
    print("Dependency installation for",
          dependencies["target"], "completed. WARNING: NO RECURSION FOR NOW")
